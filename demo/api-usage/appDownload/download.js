/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
 1. 项目名称：悟空找房app下载
 2. 页面名称：AppDownload
 3. 作者：yinqin@lifang.com
 4. 如果安装app 的情况下，打开链接会让window失去焦点，于是清除了计时器
    如果没有安装app计时器里面的代码会执行，所以跳向了下载页
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
function AppDownload(options) {
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    默认的链接配置
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.defaults = {
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        android custom url schemes
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "androidSchemes": "",
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        ios custom url schemes
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "isoSchemes": "",
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        android download  url
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "androidDownloadLink": "",
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        ios download url
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
        "iosDownloadLink": ""
    };
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    ua的值
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.ua = navigator.userAgent;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    整合默认值和用户传进来的值
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.opts = $.extend({}, this.defaults, options);

    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    全局的定时器
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.timeout = null;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    全局的超时时间
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.t = 1000;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    是否安装app标志
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.hasApp = true;
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    初始化
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.init();
}

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
打开跳转链接
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
AppDownload.prototype.init = function() {
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    判断是否为微信,如果为微信，则退出
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    if (this.browser() == "wechat") {
        alert("请在手机浏览器里打开！");
        return;
    }
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    打开跳转链接
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.openDownloadLink();
    /*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    是否安装app标志
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
    this.isHasApp();
};

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
打开跳转链接
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
AppDownload.prototype.openDownloadLink = function() {
    var classSelf = this;
    setTimeout(function() {
        var browser = classSelf.browser(),
            downloadUrl = "";
        if (browser == "ios") {
            downloadUrl = classSelf.opts.iosDownloadLink;
        } else if (browser == "android") {
            downloadUrl = classSelf.opts.androidDownloadLink;
        }
        if (!this.hasApp) {
            top.window.location = downloadUrl;
            console.log("未安装");
        } else {
            console.log("已安装");
        }
    }, 2000);
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
本地是否安装app
 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
AppDownload.prototype.isHasApp = function() {
    var classSelf = this,
        ifr = $('<iframe id="ifr"></iframe>'),
        browser = classSelf.browser();
    t1 = Date.now();
    if (browser == "ios") {
        window.location.href = classSelf.opts.isoSchemes;
    } else if (browser == "android") {
        ifr.attr('src', classSelf.opts.androidSchemes);
    }
    $('body').append(ifr);
    timeout = setTimeout(function() {
        classSelf.tryToOpenApp(t1);
    }, classSelf.t);
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
tryToOpenApp
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
AppDownload.prototype.tryToOpenApp = function() {
    var t2 = Date.now();
    if (!t1 || t2 - t1 < this.t + 200) {
        this.hasApp = false;
    }
};
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
检测浏览器类型
1.wechat :微信
2.ios：苹果系统
3.android ：安卓系统
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------*/
AppDownload.prototype.browser = function() {
    var browser = "";
    if (this.ua.match(/MicroMessenger/i)) {
        browser = "wechat";
    } else if (this.ua.match(/(iPhone|iPod|iPad);?/i)) {
        browser = "ios";
    } else if (this.ua.match(/android/i)) {
        browser = "android";
    }
    return browser;
};
